{% extends "base.html" %}

{% block title %}Início - Programa Equilíbrio{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section bg-primary text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="d-flex align-items-center mb-4">
                    <img src="{{ url_for('static', filename='images/logo-conecta.png') }}" 
                         alt="Belz Conecta Saúde" 
                         height="60" 
                         class="me-4">
                    <div>
                        <h1 class="display-4 fw-bold mb-0">
                            Programa Equilíbrio
                        </h1>
                        <p class="lead mb-0 opacity-75">
                            powered by Belz Conecta Saúde
                        </p>
                    </div>
                </div>
                <p class="lead mb-4">
                    Diagnóstico Corporativo de Saúde Mental e Ergonomia
                </p>
                <p class="mb-4">
                    Avaliação completa para identificar necessidades e oportunidades de melhoria 
                    no ambiente de trabalho, focando em saúde mental e ergonomia.
                </p>
                <div class="d-flex flex-wrap gap-3 mb-4">
                    <div class="badge bg-light text-primary fs-6 p-2">
                        <i class="fas fa-brain me-1"></i> Saúde Mental
                    </div>
                    <div class="badge bg-light text-primary fs-6 p-2">
                        <i class="fas fa-cog me-1"></i> Ergonomia
                    </div>
                    <div class="badge bg-light text-primary fs-6 p-2">
                        <i class="fas fa-chart-bar me-1"></i> Relatório PDF
                    </div>
                    <div class="badge bg-light text-primary fs-6 p-2">
                        <i class="fab fa-whatsapp me-1"></i> Envio via WhatsApp
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="text-center">
                    <div class="hero-icon-container">
                        <i class="fas fa-chart-line fa-8x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Dados da Empresa Section -->
<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-gradient-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-building me-2"></i>
                             Dados da Empresa
                        </h3>
                        <small class="opacity-75">Preencha as informações para iniciar o diagnóstico</small>
                    </div>
                    <div class="card-body">
                        <form id="formDadosEmpresa">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">CNPJ *</label>
                                    <input type="text" class="form-control" name="cnpj" id="cnpjInput"
                                           placeholder="00.000.000/0001-00" maxlength="18" required>
                                    <div class="invalid-feedback" id="cnpjError"></div>
                                    <div class="valid-feedback">CNPJ válido! Dados preenchidos automaticamente.</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Razão Social *</label>
                                    <input type="text" class="form-control" name="razao_social" id="razaoSocialInput"
                                           placeholder="Ex: Belz Conecta Saúde Ltda" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Nome Fantasia</label>
                                    <input type="text" class="form-control" name="nome_fantasia" id="nomeFantasiaInput"
                                           placeholder="Nome fantasia da empresa">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">RH Responsável *</label>
                                    <input type="text" class="form-control" name="rh_responsavel" 
                                           placeholder="Nome do responsável pelo RH" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Cargo</label>
                                    <input type="text" class="form-control" name="cargo" 
                                           placeholder="Ex: Gerente de RH">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">E-mail de Contato</label>
                                    <input type="email" class="form-control" name="email" 
                                           placeholder="email@empresa.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">WhatsApp *</label>
                                    <input type="tel" class="form-control" name="whatsapp" 
                                           id="whatsapp"
                                           placeholder="(11) 99999-9999" 
                                           maxlength="15" required>
                                    <div class="form-text">
                                        <i class="fab fa-whatsapp text-success"></i>
                                        Número para contato e envio do relatório
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Número de Colaboradores</label>
                                    <select class="form-select" name="num_colaboradores">
                                        <option value="">Selecione</option>
                                        <option value="1-50">1 a 50 colaboradores</option>
                                        <option value="51-100">51 a 100 colaboradores</option>
                                        <option value="101-250">101 a 250 colaboradores</option>
                                        <option value="251-500">251 a 500 colaboradores</option>
                                        <option value="501-1000">501 a 1000 colaboradores</option>
                                        <option value="1000+">Mais de 1000 colaboradores</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Setor/Ramo de Atividade</label>
                                    <input type="text" class="form-control" name="setor" 
                                           placeholder="Ex: Tecnologia, Saúde, Educação">
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    Iniciar Diagnóstico →
                                </button>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-info border-0" style="background-color: #e3f2fd;">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-shield-alt text-primary me-3 fs-4"></i>
                                            <div>
                                                <h6 class="alert-heading mb-1">Privacidade e Segurança</h6>
                                                <p class="mb-0 small">
                                                    Seus dados são protegidos e utilizados apenas para elaboração e envio do relatório via WhatsApp.
                                                    O número será utilizado exclusivamente para comunicação sobre este diagnóstico.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col">
                <h2 class="fw-bold">O que avaliamos?</h2>
                <p class="text-muted">Áreas de foco do nosso diagnóstico corporativo</p>
            </div>
        </div>
        
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon mb-3" style="color: var(--primary-color);">
                            <i class="fas fa-brain fa-3x"></i>
                        </div>
                        <h4 class="card-title" style="color: var(--primary-color);">🧠 Saúde Mental</h4>
                        <p class="card-text text-muted">
                            Avaliação de fatores de estresse, burnout, clima organizacional 
                            e bem-estar psicológico dos colaboradores.
                        </p>
                        <ul class="list-unstyled text-start">
                            <li><i class="fas fa-check text-success me-2"></i>Fatores de estresse</li>
                            <li><i class="fas fa-check text-success me-2"></i>Sinais de burnout</li>
                            <li><i class="fas fa-check text-success me-2"></i>Clima organizacional</li>
                            <li><i class="fas fa-check text-success me-2"></i>Ações preventivas</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon mb-3" style="color: var(--secondary-color);">
                            <i class="fas fa-cog fa-3x"></i>
                        </div>
                        <h4 class="card-title" style="color: var(--secondary-color);">🔧 Ergonomia</h4>
                        <p class="card-text text-muted">
                            Análise do ambiente de trabalho, posturas, equipamentos 
                            e prevenção de lesões ocupacionais.
                        </p>
                        <ul class="list-unstyled text-start">
                            <li><i class="fas fa-check text-success me-2"></i>Dores físicas</li>
                            <li><i class="fas fa-check text-success me-2"></i>Avaliação ergonômica</li>
                            <li><i class="fas fa-check text-success me-2"></i>Ambiente de trabalho</li>
                            <li><i class="fas fa-check text-success me-2"></i>Ações preventivas</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Máscara para WhatsApp
function maskWhatsApp(input) {
    let value = input.value.replace(/\D/g, '');
    
    if (value.length <= 2) {
        value = value.replace(/(\d{0,2})/, '($1');
    } else if (value.length <= 7) {
        value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
    } else if (value.length <= 11) {
        value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
    } else {
        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }
    
    input.value = value;
}

// Aplicar máscara ao campo WhatsApp
document.getElementById('whatsapp').addEventListener('input', function() {
    maskWhatsApp(this);
});

// Aplicar máscara ao campo CNPJ
document.getElementById('cnpjInput').addEventListener('input', function() {
    let value = this.value.replace(/\D/g, '');
    
    if (value.length <= 14) {
        value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{1})$/, '$1.$2.$3/$4-$5');
        value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})$/, '$1.$2.$3/$4');
        value = value.replace(/^(\d{2})(\d{3})(\d{3})$/, '$1.$2.$3');
        value = value.replace(/^(\d{2})(\d{3})$/, '$1.$2');
        value = value.replace(/^(\d{2})$/, '$1');
    }
    
    this.value = value;
});

// Validação de WhatsApp
function validateWhatsApp(whatsapp) {
    const cleanWhatsApp = whatsapp.replace(/\D/g, '');
    return cleanWhatsApp.length >= 10;
}

document.getElementById('formDadosEmpresa').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const cnpj = document.getElementById('cnpjInput').value;
    const cnpjInput = document.getElementById('cnpjInput');
    const submitBtn = this.querySelector('button[type="submit"]');
    
    // Validar CNPJ antes de continuar
    if (!cnpj || cnpj.replace(/\D/g, '').length !== 14) {
        cnpjInput.classList.add('is-invalid');
        document.getElementById('cnpjError').textContent = 'Por favor, informe um CNPJ válido com 14 dígitos.';
        cnpjInput.focus();
        return;
    }
    
    // Mostrar loading no botão
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Validando CNPJ...';
    submitBtn.disabled = true;
    
    // Validar CNPJ via API
    fetch('/validar_cnpj', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cnpj: cnpj })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Resposta da API:', data);
        
        if (data.valid) {
            // CNPJ válido - coletar dados do formulário
            cnpjInput.classList.add('is-valid');
            cnpjInput.classList.remove('is-invalid');
            
            const formData = new FormData(this);
            const dadosEmpresa = {};
            
            for (let [key, value] of formData.entries()) {
                dadosEmpresa[key] = value;
            }
            
            // Validar WhatsApp
            if (!validateWhatsApp(dadosEmpresa.whatsapp)) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                alert('Por favor, insira um número de WhatsApp válido com pelo menos 10 dígitos.');
                document.getElementById('whatsapp').focus();
                return;
            }
            
            // Adicionar dados da API se disponível
            if (data.dados_empresa) {
                dadosEmpresa.dados_receita = data.dados_empresa;
            }
            dadosEmpresa.cnpj_validado = true;
            
            // Salvar dados no sessionStorage
            sessionStorage.setItem('dadosEmpresa', JSON.stringify(dadosEmpresa));
            
            console.log('Dados salvos no sessionStorage:', dadosEmpresa);
            
            // Redirecionar para o questionário
            window.location.href = '/questionario';
            
        } else {
            // CNPJ inválido ou empresa inativa
            cnpjInput.classList.add('is-invalid');
            cnpjInput.classList.remove('is-valid');
            document.getElementById('cnpjError').textContent = data.message || 'CNPJ não encontrado ou erro na consulta';
            
            // Restaurar botão
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            cnpjInput.focus();
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        cnpjInput.classList.add('is-invalid');
        cnpjInput.classList.remove('is-valid');
        document.getElementById('cnpjError').textContent = 'Erro ao validar CNPJ. Verifique sua conexão e tente novamente.';
        
        // Restaurar botão
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        cnpjInput.focus();
    });
});
</script>
{% endblock %}
