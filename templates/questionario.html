{% extends "base.html" %}

{% block title %}Question√°rio - Programa Equil√≠brio{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="progress shadow-sm" style="height: 12px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: 8%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));" id="progressBar"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted fw-bold">Etapa <span id="etapaAtual">1</span> de {{ perguntas|length + 1 }}</small>
                    <small class="text-muted fw-bold"><span id="porcentagem">8</span>% conclu√≠do</small>
                </div>
            </div>

            <!-- Question√°rio -->
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <form id="formQuestionario">
                        <!-- Dados da Empresa (Etapa 0) -->
                        <div class="pergunta-container" data-pergunta="0" id="dadosEmpresa">
                            <div class="mb-4">
                                <h4 class="fw-bold mb-3" style="color: var(--primary-color);">
                                    üè¢ Dados da Empresa
                                </h4>
                                <p class="text-muted fst-italic">
                                    <i class="fas fa-info-circle me-2" style="color: var(--secondary-color);"></i>
                                    Para come√ßar o diagn√≥stico, precisamos validar os dados da sua empresa
                                </p>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="cnpj" class="form-label fw-bold">CNPJ *</label>
                                    <input type="text" class="form-control form-control-lg" id="cnpj" 
                                           placeholder="00.000.000/0001-00" maxlength="18" required>
                                    <div class="invalid-feedback" id="cnpjError"></div>
                                    <div class="valid-feedback">CNPJ v√°lido!</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-lg mt-4" 
                                            id="validarCnpj" disabled>
                                        <i class="fas fa-search me-2"></i>Validar CNPJ
                                    </button>
                                </div>
                            </div>

                            <!-- Dados preenchidos automaticamente -->
                            <div id="dadosEmpresaContainer" style="display: none;">
                                <div class="alert alert-success" role="alert">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Empresa encontrada!</strong> Verifique e complete os dados abaixo.
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="razaoSocial" class="form-label fw-bold">Raz√£o Social *</label>
                                        <input type="text" class="form-control form-control-lg" id="razaoSocial" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="nomeFantasia" class="form-label fw-bold">Nome Fantasia</label>
                                        <input type="text" class="form-control form-control-lg" id="nomeFantasia" readonly>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="rhResponsavel" class="form-label fw-bold">RH Respons√°vel *</label>
                                        <input type="text" class="form-control form-control-lg" id="rhResponsavel" 
                                               placeholder="Nome completo" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cargoRh" class="form-label fw-bold">Cargo *</label>
                                        <input type="text" class="form-control form-control-lg" id="cargoRh" 
                                               placeholder="Ex: Analista de RH" required>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="emailContato" class="form-label fw-bold">E-mail de Contato *</label>
                                        <input type="email" class="form-control form-control-lg" id="emailContato" 
                                               placeholder="email@empresa.com.br" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="whatsapp" class="form-label fw-bold">WhatsApp *</label>
                                        <input type="tel" class="form-control form-control-lg" id="whatsapp" 
                                               placeholder="(11) 99999-9999" required>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="numColaboradores" class="form-label fw-bold">N√∫mero de Colaboradores *</label>
                                        <select class="form-select form-select-lg" id="numColaboradores" required>
                                            <option value="">Selecione</option>
                                            <option value="1-10">1 a 10 funcion√°rios</option>
                                            <option value="11-50">11 a 50 funcion√°rios</option>
                                            <option value="51-100">51 a 100 funcion√°rios</option>
                                            <option value="101-500">101 a 500 funcion√°rios</option>
                                            <option value="501-1000">501 a 1000 funcion√°rios</option>
                                            <option value="1000+">Mais de 1000 funcion√°rios</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="navegacao-container d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary btn-lg" onclick="proximaEtapa()" 
                                        id="btnProximaEtapa" disabled>
                                    Iniciar Diagn√≥stico ‚Üí<i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Perguntas do question√°rio -->
                        {% for pergunta in perguntas %}
                        <div class="pergunta-container" data-pergunta="{{ pergunta.id }}" 
                             style="display: none;">
                            
                            <div class="mb-4">
                                <h4 class="fw-bold mb-3" style="color: var(--primary-color);">{{ pergunta.titulo }}</h4>
                                <p class="text-muted fst-italic">
                                    <i class="fas fa-target me-2" style="color: var(--secondary-color);"></i>
                                    {{ pergunta.objetivo }}
                                </p>
                            </div>

                            <div class="opcoes-container">
                                {% for opcao in pergunta.opcoes %}
                                <div class="opcao-item mb-3">
                                    <input type="radio" class="btn-check" 
                                           name="pergunta_{{ pergunta.id }}" 
                                           value="{{ opcao.valor }}" 
                                           id="opcao_{{ pergunta.id }}_{{ opcao.valor }}"
                                           autocomplete="off">
                                    <label class="btn btn-outline-primary btn-lg w-100 text-start p-3" 
                                           for="opcao_{{ pergunta.id }}_{{ opcao.valor }}">
                                        {{ opcao.texto }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="navegacao-container d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="voltarPergunta()">
                                    <i class="fas fa-arrow-left me-2"></i>‚Üê Anterior
                                </button>

                                {% if pergunta.id < perguntas|length %}
                                <button type="button" class="btn btn-primary" onclick="proximaPergunta()" disabled>
                                    Pr√≥xima ‚Üí<i class="fas fa-arrow-right ms-2"></i>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-success btn-lg" onclick="finalizarQuestionario()" disabled>
                                    <i class="fas fa-check me-2"></i>Finalizar Diagn√≥stico
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </form>
                </div>
            </div>

            <!-- Loading Modal -->
            <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center py-5">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <h5 id="loadingText">Validando CNPJ...</h5>
                            <p class="text-muted" id="loadingSubText">Consultando dados da empresa na Receita Federal.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
// Configura√ß√µes do question√°rio
let etapaAtual = 0;
let totalEtapas = {{ perguntas|length + 1 }};
let dadosEmpresa = {};
let respostas = {};

$(document).ready(function() {
    // M√°scaras para os campos
    $('#cnpj').mask('00.000.000/0000-00', {
        reverse: false,
        placeholder: '00.000.000/0000-00'
    });
    
    $('#whatsapp').mask('(00) 00000-0000', {
        placeholder: '(11) 99999-9999'
    });
    
    // Valida√ß√£o em tempo real do CNPJ
    $('#cnpj').on('input', function() {
        const cnpj = $(this).val();
        if (cnpj.length === 18) {
            $('#validarCnpj').prop('disabled', false);
            $(this).removeClass('is-invalid').removeClass('is-valid');
        } else {
            $('#validarCnpj').prop('disabled', true);
            $('#dadosEmpresaContainer').hide();
            $('#btnProximaEtapa').prop('disabled', true);
        }
    });
    
    // Valida√ß√£o dos campos obrigat√≥rios
    $('#dadosEmpresaContainer input[required], #dadosEmpresaContainer select[required]').on('input change', function() {
        validarDadosEmpresa();
    });
});

function validarCnpj() {
    const cnpj = $('#cnpj').val();
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    $('#loadingText').text('Validando CNPJ...');
    $('#loadingSubText').text('Consultando dados da empresa na Receita Federal.');
    loadingModal.show();
    
    $.ajax({
        url: '/validar_cnpj',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ cnpj: cnpj }),
        success: function(response) {
            loadingModal.hide();
            
            if (response.valid) {
                $('#cnpj').addClass('is-valid').removeClass('is-invalid');
                preencherDadosEmpresa(response.dados_empresa);
                $('#dadosEmpresaContainer').show();
                
                // Scroll para os dados da empresa
                $('#dadosEmpresaContainer')[0].scrollIntoView({ 
                    behavior: 'smooth' 
                });
            } else {
                $('#cnpj').addClass('is-invalid').removeClass('is-valid');
                $('#cnpjError').text(response.message);
                $('#dadosEmpresaContainer').hide();
            }
        },
        error: function(xhr, status, error) {
            loadingModal.hide();
            $('#cnpj').addClass('is-invalid').removeClass('is-valid');
            $('#cnpjError').text('Erro ao validar CNPJ. Tente novamente.');
        }
    });
}

function preencherDadosEmpresa(dados) {
    dadosEmpresa = dados;
    
    $('#razaoSocial').val(dados.razao_social || '');
    $('#nomeFantasia').val(dados.nome_fantasia || '');
    
    // Se tem email da API, preenche
    if (dados.email) {
        $('#emailContato').val(dados.email);
    }
    
    // Se tem telefone da API, tenta preencher o WhatsApp
    if (dados.telefone) {
        $('#whatsapp').val(dados.telefone);
    }
    
    validarDadosEmpresa();
}

function validarDadosEmpresa() {
    const campos = ['#rhResponsavel', '#cargoRh', '#emailContato', '#whatsapp', '#numColaboradores'];
    let todosPreenchidos = true;
    
    campos.forEach(campo => {
        if (!$(campo).val().trim()) {
            todosPreenchidos = false;
        }
    });
    
    $('#btnProximaEtapa').prop('disabled', !todosPreenchidos);
}

function proximaEtapa() {
    if (etapaAtual === 0) {
        // Coletar dados da empresa
        dadosEmpresa = {
            ...dadosEmpresa,
            cnpj: $('#cnpj').val(),
            razao_social: $('#razaoSocial').val(),
            nome_fantasia: $('#nomeFantasia').val(),
            rh_responsavel: $('#rhResponsavel').val(),
            cargo: $('#cargoRh').val(),
            email: $('#emailContato').val(),
            whatsapp: $('#whatsapp').val(),
            num_colaboradores: $('#numColaboradores').val()
        };
        
        etapaAtual = 1;
    } else {
        etapaAtual++;
    }
    
    atualizarProgresso();
    mostrarEtapa(etapaAtual);
}

function proximaPergunta() {
    etapaAtual++;
    atualizarProgresso();
    mostrarEtapa(etapaAtual);
}

function voltarPergunta() {
    etapaAtual--;
    atualizarProgresso();
    mostrarEtapa(etapaAtual);
}

function mostrarEtapa(etapa) {
    $('.pergunta-container').hide();
    $(`.pergunta-container[data-pergunta="${etapa}"]`).show();
    
    // Verificar se resposta est√° selecionada para perguntas > 0
    if (etapa > 0) {
        const radioSelecionado = $(`input[name="pergunta_${etapa}"]:checked`);
        const botaoProximo = $(`.pergunta-container[data-pergunta="${etapa}"] .btn-primary, .pergunta-container[data-pergunta="${etapa}"] .btn-success`);
        botaoProximo.prop('disabled', radioSelecionado.length === 0);
    }
}

function atualizarProgresso() {
    const porcentagem = Math.round((etapaAtual / totalEtapas) * 100);
    $('#progressBar').css('width', porcentagem + '%');
    $('#etapaAtual').text(etapaAtual + 1);
    $('#porcentagem').text(porcentagem);
}

// Event listener para as op√ß√µes de resposta
$(document).on('change', 'input[type="radio"]', function() {
    const perguntaId = $(this).attr('name').replace('pergunta_', '');
    const valor = $(this).val();
    
    respostas[perguntaId] = valor;
    
    // Habilitar bot√£o de pr√≥xima pergunta
    const botaoProximo = $(this).closest('.pergunta-container').find('.btn-primary, .btn-success');
    botaoProximo.prop('disabled', false);
});

// Event listener para o bot√£o de validar CNPJ
$('#validarCnpj').on('click', validarCnpj);

function finalizarQuestionario() {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    $('#loadingText').text('Processando diagn√≥stico...');
    $('#loadingSubText').text('Analisando as respostas e gerando recomenda√ß√µes personalizadas.');
    loadingModal.show();
    
    const dadosCompletos = {
        dados_empresa: dadosEmpresa,
        respostas: respostas
    };
    
    $.ajax({
        url: '/processar_questionario',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dadosCompletos),
        success: function(response) {
            loadingModal.hide();
            
            if (response.status === 'success') {
                window.location.href = response.redirect;
            } else {
                alert('Erro: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            loadingModal.hide();
            
            let errorMessage = 'Erro ao processar question√°rio.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            }
            
            alert(errorMessage);
        }
    });
}

// Inicializar
$(document).ready(function() {
    atualizarProgresso();
    mostrarEtapa(0);
});
</script>
{% endblock %}
const totalPerguntas = parseInt('{{ perguntas|length }}');
const respostas = {};

// Carregar dados da empresa do sessionStorage  
const dadosEmpresa = JSON.parse(sessionStorage.getItem('dadosEmpresa') || '{}');

// Fun√ß√£o para atualizar a barra de progresso
function atualizarProgresso() {
    const porcentagem = Math.round((perguntaAtual / totalPerguntas) * 100);
    document.getElementById('progressBar').style.width = porcentagem + '%';
    document.getElementById('questaoAtual').textContent = perguntaAtual;
    document.getElementById('porcentagem').textContent = porcentagem;
}

// Fun√ß√£o para verificar se a pergunta atual foi respondida
function verificarResposta() {
    const opcaoSelecionada = document.querySelector('input[name="pergunta_' + perguntaAtual + '"]:checked');
    const botaoProximo = document.querySelector('.pergunta-container[data-pergunta="' + perguntaAtual + '"] .btn-primary, .pergunta-container[data-pergunta="' + perguntaAtual + '"] .btn-success');
    
    if (opcaoSelecionada) {
        respostas[perguntaAtual] = opcaoSelecionada.value;
        if (botaoProximo) {
            botaoProximo.disabled = false;
        }
    } else {
        if (botaoProximo) {
            botaoProximo.disabled = true;
        }
    }
}

// Fun√ß√£o para ir para a pr√≥xima pergunta
function proximaPergunta() {
    if (perguntaAtual < totalPerguntas) {
        // Esconder pergunta atual
        document.querySelector(`[data-pergunta="${perguntaAtual}"]`).style.display = 'none';
        
        perguntaAtual++;
        
        // Mostrar pr√≥xima pergunta
        document.querySelector(`[data-pergunta="${perguntaAtual}"]`).style.display = 'block';
        
        atualizarProgresso();
        verificarResposta();
    }
}

// Fun√ß√£o para voltar para a pergunta anterior
function voltarPergunta() {
    if (perguntaAtual > 1) {
        // Esconder pergunta atual
        document.querySelector(`[data-pergunta="${perguntaAtual}"]`).style.display = 'none';
        
        perguntaAtual--;
        
        // Mostrar pergunta anterior
        document.querySelector(`[data-pergunta="${perguntaAtual}"]`).style.display = 'block';
        
        atualizarProgresso();
        verificarResposta();
    }
}

// Fun√ß√£o para finalizar o question√°rio
function finalizarQuestionario() {
    // Mostrar modal de carregamento
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Preparar dados para envio
    const dadosCompletos = {
        dados_empresa: dadosEmpresa,
        respostas: respostas,
        data_preenchimento: new Date().toISOString()
    };
    
    // Enviar dados para o servidor
    fetch('/processar_questionario', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dadosCompletos)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            window.location.href = data.redirect;
        } else {
            alert('Erro ao processar question√°rio: ' + data.message);
            loadingModal.hide();
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar question√°rio. Tente novamente.');
        loadingModal.hide();
    });
}

// Event listeners para as op√ß√µes
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar listeners para todas as op√ß√µes
    const opcoes = document.querySelectorAll('input[type="radio"]');
    opcoes.forEach(opcao => {
        opcao.addEventListener('change', verificarResposta);
    });
    
    // Verificar se h√° dados da empresa
    if (Object.keys(dadosEmpresa).length === 0) {
        alert('Por favor, preencha os dados da empresa primeiro.');
        window.location.href = '/';
    }
});

// Inicializar
atualizarProgresso();
</script>
{% endblock %}
