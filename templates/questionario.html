{% extends "base.html" %}

{% block title %}Questionário - Programa Equilíbrio{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="progress shadow-sm" style="height: 12px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: 0%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));" id="progressBar"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted fw-bold">Questão <span id="etapaAtual">1</span> de {{ perguntas|length }}</small>
                    <small class="text-muted fw-bold"><span id="porcentagem">0</span>% concluído</small>
                </div>
            </div>

            <!-- Dados da empresa (exibição compacta) -->
            <div class="mb-4">
                <div class="alert alert-primary d-flex align-items-center">
                    <i class="fas fa-building me-2"></i>
                    <div>
                        <strong id="nomeEmpresaDisplay">Carregando dados...</strong><br>
                        <small>CNPJ: <span id="cnpjEmpresaDisplay"></span></small>
                    </div>
                </div>
            </div>

            <!-- Questionário -->
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <form id="formQuestionario">
                        <!-- Perguntas do questionário -->
                        {% for pergunta in perguntas %}
                        <div class="pergunta-container" data-pergunta="{{ pergunta.id }}" 
                             {% if pergunta.id != 1 %}style="display: none;"{% endif %}>
                            
                            <div class="mb-4">
                                <h4 class="fw-bold mb-3" style="color: var(--primary-color);">{{ pergunta.titulo }}</h4>
                                <p class="text-muted fst-italic">
                                    <i class="fas fa-target me-2" style="color: var(--secondary-color);"></i>
                                    {{ pergunta.objetivo }}
                                </p>
                            </div>

                            <div class="opcoes-container">
                                {% for opcao in pergunta.opcoes %}
                                <div class="opcao-item mb-3">
                                    <input type="radio" class="btn-check" 
                                           name="pergunta_{{ pergunta.id }}" 
                                           value="{{ opcao.valor }}" 
                                           id="opcao_{{ pergunta.id }}_{{ loop.index }}"
                                           autocomplete="off">
                                    <label class="btn btn-outline-primary btn-lg w-100 text-start p-4" 
                                           for="opcao_{{ pergunta.id }}_{{ loop.index }}"
                                           style="transition: all 0.3s ease; border: 2px solid #dee2e6;">
                                        <div class="d-flex align-items-start">
                                            <div class="me-3 pt-1">
                                                <i class="fas fa-circle-check text-success d-none"></i>
                                                <i class="fas fa-circle text-muted"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold mb-2" style="font-size: 1.1rem;">{{ opcao.texto }}</div>
                                                {% if opcao.descricao %}
                                                <div class="text-muted">{{ opcao.descricao }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="navegacao-container d-flex justify-content-between align-items-center mt-5">
                                <button type="button" class="btn btn-outline-secondary" onclick="perguntaAnterior()" 
                                        {% if pergunta.id == 1 %}style="visibility: hidden;"{% endif %}>
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                                
                                <div class="text-center">
                                    <small class="text-muted">Pergunta {{ pergunta.id }} de {{ perguntas|length }}</small>
                                </div>

                                {% if pergunta.id < perguntas|length %}
                                <button type="button" class="btn btn-primary btn-lg" onclick="proximaPergunta()" disabled>
                                    Próxima <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-success btn-lg" onclick="proximaPergunta()" disabled>
                                    Finalizar Diagnóstico <i class="fas fa-check ms-2"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary mb-4" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <h5 class="mb-2" id="loadingText">Processando diagnóstico...</h5>
                <p class="text-muted mb-0" id="loadingSubText">
                    Analisando as respostas e gerando recomendações personalizadas.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- jQuery primeiro -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- Fallback para jQuery se CDN falhar -->
<script>
if (!window.jQuery) {
    console.warn('jQuery CDN falhou, carregando fallback...');
    document.write('<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"><\/script>');
}
</script>

<!-- jQuery Mask depois do jQuery -->
<script>
// Verificar se jQuery está disponível antes de carregar mask
if (window.jQuery) {
    // Carregar jQuery Mask
    var script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js';
    script.onerror = function() {
        console.warn('jQuery Mask CDN falhou');
    };
    document.head.appendChild(script);
} else {
    console.warn('jQuery não disponível, pulando jQuery Mask');
}
</script>
<script>
// Variáveis globais
let dadosEmpresa = {};
let respostas = {};
let perguntaAtual = 1;
const totalPerguntas = parseInt('{{ perguntas|length }}');

// Função para atualizar a barra de progresso
function atualizarProgresso() {
    try {
        const totalPerguntasLocal = parseInt('{{ perguntas|length }}') || 1; // Evitar divisão por zero
        const porcentagem = Math.round(((perguntaAtual - 1) / totalPerguntasLocal) * 100);
        
        console.log(`Progresso: pergunta ${perguntaAtual} de ${totalPerguntasLocal} (${porcentagem}%)`);
        
        // Usar jQuery se disponível, senão usar JavaScript vanilla
        if (window.jQuery && window.$) {
            $('#progressBar').css('width', porcentagem + '%');
            $('#etapaAtual').text(perguntaAtual);
            $('#porcentagem').text(porcentagem);
        } else {
            // Fallback para JavaScript vanilla
            const progressBar = document.getElementById('progressBar');
            const etapaAtual = document.getElementById('etapaAtual');
            const porcentagemEl = document.getElementById('porcentagem');
            
            if (progressBar) progressBar.style.width = porcentagem + '%';
            if (etapaAtual) etapaAtual.textContent = perguntaAtual;
            if (porcentagemEl) porcentagemEl.textContent = porcentagem;
        }
    } catch (error) {
        console.error('Erro em atualizarProgresso:', error);
    }
}

// Função para mostrar pergunta específica
function mostrarPergunta(numero) {
    try {
        console.log(`Mostrando pergunta ${numero}...`);
        
        // Usar jQuery se disponível, senão usar JavaScript vanilla
        if (window.jQuery && window.$) {
            $('.pergunta-container').hide();
            
            const perguntaElement = $('.pergunta-container[data-pergunta="' + numero + '"]');
            console.log(`Elemento da pergunta encontrado: ${perguntaElement.length > 0}`);
            
            if (perguntaElement.length > 0) {
                perguntaElement.show();
                console.log(`Pergunta ${numero} exibida com sucesso`);
            } else {
                console.error(`Pergunta ${numero} não encontrada!`);
            }
        } else {
            // Fallback para JavaScript vanilla
            const perguntaContainers = document.querySelectorAll('.pergunta-container');
            perguntaContainers.forEach(container => {
                container.style.display = 'none';
            });
            
            const perguntaElement = document.querySelector('.pergunta-container[data-pergunta="' + numero + '"]');
            console.log(`Elemento da pergunta encontrado: ${perguntaElement !== null}`);
            
            if (perguntaElement) {
                perguntaElement.style.display = 'block';
                console.log(`Pergunta ${numero} exibida com sucesso`);
            } else {
                console.error(`Pergunta ${numero} não encontrada!`);
            }
        }
    } catch (error) {
        console.error('Erro em mostrarPergunta:', error);
    }
}

// Função para próxima pergunta
function proximaPergunta() {
    if (perguntaAtual < totalPerguntas) {
        perguntaAtual++;
        mostrarPergunta(perguntaAtual);
        atualizarProgresso();
        // Scroll para o topo - funciona com ou sem jQuery
        if (window.jQuery && window.$) {
            $('html, body').animate({ scrollTop: 0 }, 500);
        } else {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    } else {
        finalizarQuestionario();
    }
}

// Função para pergunta anterior
function perguntaAnterior() {
    if (perguntaAtual > 1) {
        perguntaAtual--;
        mostrarPergunta(perguntaAtual);
        atualizarProgresso();
        // Scroll para o topo - funciona com ou sem jQuery
        if (window.jQuery && window.$) {
            $('html, body').animate({ scrollTop: 0 }, 500);
        } else {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
}

// Função para verificar se pergunta foi respondida
function verificarResposta() {
    try {
        let opcaoSelecionada, botaoProximo;
        
        if (window.jQuery && window.$) {
            // Usar jQuery se disponível
            opcaoSelecionada = $('input[name="pergunta_' + perguntaAtual + '"]:checked');
            botaoProximo = $('.pergunta-container[data-pergunta="' + perguntaAtual + '"] .btn-primary, .pergunta-container[data-pergunta="' + perguntaAtual + '"] .btn-success');
            
            if (opcaoSelecionada.length > 0) {
                respostas[perguntaAtual] = opcaoSelecionada.val();
                botaoProximo.prop('disabled', false);
            } else {
                botaoProximo.prop('disabled', true);
            }
        } else {
            // Usar JavaScript vanilla
            opcaoSelecionada = document.querySelector('input[name="pergunta_' + perguntaAtual + '"]:checked');
            botaoProximo = document.querySelector('.pergunta-container[data-pergunta="' + perguntaAtual + '"] .btn-primary, .pergunta-container[data-pergunta="' + perguntaAtual + '"] .btn-success');
            
            if (opcaoSelecionada) {
                respostas[perguntaAtual] = opcaoSelecionada.value;
                if (botaoProximo) botaoProximo.disabled = false;
            } else {
                if (botaoProximo) botaoProximo.disabled = true;
            }
        }
    } catch (error) {
        console.error('Erro em verificarResposta:', error);
    }
}

// Função para formatar CNPJ
function formatarCNPJ(cnpj) {
    if (!cnpj) {
        return '---';
    }
    
    // Garantir que cnpj é uma string
    const cnpjStr = String(cnpj);
    const digits = cnpjStr.replace(/\D/g, '');
    
    // Verificar se tem 14 dígitos (formato válido de CNPJ)
    if (digits.length !== 14) {
        return cnpj; // Retornar como recebido se não for válido
    }
    
    return digits.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
}

function finalizarQuestionario() {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    // Atualizar textos do modal
    const loadingText = document.getElementById('loadingText');
    const loadingSubText = document.getElementById('loadingSubText');
    
    if (loadingText) loadingText.textContent = 'Processando diagnóstico...';
    if (loadingSubText) loadingSubText.textContent = 'Analisando as respostas e gerando recomendações personalizadas.';
    
    loadingModal.show();
    
    const dadosCompletos = {
        dados_empresa: dadosEmpresa,
        respostas: respostas
    };
    
    // Usar jQuery se disponível, senão usar fetch API
    if (window.jQuery && window.$) {
        $.ajax({
            url: '/processar_questionario',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dadosCompletos),
            success: function(response) {
                loadingModal.hide();
                
                if (response.status === 'success') {
                    window.location.href = response.redirect;
                } else {
                    alert('Erro: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                loadingModal.hide();
                
                let errorMessage = 'Erro ao processar questionário.';
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    errorMessage = errorData.message || errorMessage;
                } catch (e) {
                    // Usar mensagem padrão
                }
                
                alert(errorMessage + ' Por favor, tente novamente.');
            }
        });
    } else {
        // Fallback usando fetch API
        fetch('/processar_questionario', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dadosCompletos)
        })
        .then(response => response.json())
        .then(data => {
            loadingModal.hide();
            
            if (data.status === 'success') {
                window.location.href = data.redirect;
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            loadingModal.hide();
            console.error('Erro ao processar questionário:', error);
            alert('Erro ao processar questionário. Por favor, tente novamente.');
        });
    }
}

// Event listeners para as opções
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 [QUESTIONARIO] DOM carregado, iniciando validação...');
    
    // Carregar dados da empresa do sessionStorage
    const dadosEmpresaStorage = sessionStorage.getItem('dadosEmpresa');
    console.log('📦 [QUESTIONARIO] SessionStorage raw:', dadosEmpresaStorage);
    
    if (dadosEmpresaStorage) {
        try {
            const dadosCarregados = JSON.parse(dadosEmpresaStorage);
            
            // DEBUG: Mostrar dados carregados
            console.log('📋 [QUESTIONARIO] Dados do sessionStorage parsed:', dadosCarregados);
            console.log('📋 [QUESTIONARIO] cnpj_validado:', dadosCarregados.cnpj_validado);
            console.log('📋 [QUESTIONARIO] dados_receita:', dadosCarregados.dados_receita);
            console.log('📋 [QUESTIONARIO] cnpj:', dadosCarregados.cnpj);
            
            // Verificar se CNPJ existe nos dados (mais flexível)
            const temCNPJ = dadosCarregados.cnpj || (dadosCarregados.dados_receita && dadosCarregados.dados_receita.cnpj);
            const cnpjValidado = dadosCarregados.cnpj_validado === true;
            
            console.log('🔍 [QUESTIONARIO] temCNPJ:', temCNPJ);
            console.log('🔍 [QUESTIONARIO] cnpjValidado:', cnpjValidado);
            console.log('🔍 [QUESTIONARIO] Condição final:', temCNPJ && (cnpjValidado || dadosCarregados.dados_receita));
            
            // Permitir prosseguir se tem CNPJ válido, mesmo sem todos os dados da Receita
            if (temCNPJ && (cnpjValidado || dadosCarregados.dados_receita)) {
                console.log('✅ [QUESTIONARIO] Validação passou - prosseguindo...');
                
                // Usar dados da página inicial
                dadosEmpresa = dadosCarregados;
                
                console.log('Dados validados - prosseguindo com o questionário');
                
                // Exibir dados da empresa na barra superior
                let razaoSocial = 'Empresa';
                let cnpj = '---';
                
                try {
                    console.log('🔍 [DEBUG] Iniciando exibição de dados da empresa...');
                    console.log('🔍 [DEBUG] dadosCarregados:', dadosCarregados);
                    console.log('🔍 [DEBUG] dadosCarregados.dados_receita:', dadosCarregados.dados_receita);
                    
                    // Tentar pegar dados da receita primeiro, depois dados básicos
                    if (dadosCarregados.dados_receita && typeof dadosCarregados.dados_receita === 'object') {
                        console.log('📋 [DEBUG] Usando dados da receita...');
                        razaoSocial = dadosCarregados.dados_receita.razao_social || 
                                    dadosCarregados.dados_receita.nome || 
                                    dadosCarregados.razao_social || 
                                    dadosCarregados.nome_empresa || 
                                    'Empresa';
                        
                        const cnpjReceita = dadosCarregados.dados_receita.cnpj || dadosCarregados.cnpj;
                        cnpj = formatarCNPJ(cnpjReceita);
                        console.log('📋 [DEBUG] CNPJ da receita:', cnpjReceita, '-> formatado:', cnpj);
                    } else {
                        console.log('📋 [DEBUG] Usando dados básicos...');
                        razaoSocial = dadosCarregados.razao_social || 
                                    dadosCarregados.nome_empresa || 
                                    'Empresa';
                        cnpj = formatarCNPJ(dadosCarregados.cnpj);
                        console.log('📋 [DEBUG] CNPJ básico:', dadosCarregados.cnpj, '-> formatado:', cnpj);
                    }
                    
                    console.log('📋 [DEBUG] Valores finais - Razão:', razaoSocial, 'CNPJ:', cnpj);
                    
                    // Atualizar elementos da interface
                    if (window.jQuery && window.$) {
                        // Usar jQuery se disponível
                        const nomeElement = $('#nomeEmpresaDisplay');
                        const cnpjElement = $('#cnpjEmpresaDisplay');
                        
                        if (nomeElement.length) {
                            nomeElement.text(razaoSocial);
                            console.log('✅ [DEBUG] Nome da empresa atualizado (jQuery)');
                        } else {
                            console.warn('⚠️ [DEBUG] Elemento #nomeEmpresaDisplay não encontrado');
                        }
                        
                        if (cnpjElement.length) {
                            cnpjElement.text(cnpj);
                            console.log('✅ [DEBUG] CNPJ atualizado (jQuery)');
                        } else {
                            console.warn('⚠️ [DEBUG] Elemento #cnpjEmpresaDisplay não encontrado');
                        }
                    } else {
                        // Usar JavaScript vanilla
                        const nomeElement = document.getElementById('nomeEmpresaDisplay');
                        const cnpjElement = document.getElementById('cnpjEmpresaDisplay');
                        
                        if (nomeElement) {
                            nomeElement.textContent = razaoSocial;
                            console.log('✅ [DEBUG] Nome da empresa atualizado (vanilla JS)');
                        } else {
                            console.warn('⚠️ [DEBUG] Elemento #nomeEmpresaDisplay não encontrado');
                        }
                        
                        if (cnpjElement) {
                            cnpjElement.textContent = cnpj;
                            console.log('✅ [DEBUG] CNPJ atualizado (vanilla JS)');
                        } else {
                            console.warn('⚠️ [DEBUG] Elemento #cnpjEmpresaDisplay não encontrado');
                        }
                    }
                    
                    console.log('✅ [DEBUG] Dados exibidos com sucesso');
                } catch (displayError) {
                    console.error('❌ [QUESTIONARIO] Erro ao exibir dados da empresa:', displayError);
                    console.error('❌ [QUESTIONARIO] Stack trace:', displayError.stack);
                    console.log('📋 [QUESTIONARIO] Dados que causaram erro:', dadosCarregados);
                    
                    // Fallback seguro
                    try {
                        if (window.jQuery && window.$) {
                            $('#nomeEmpresaDisplay').text('Empresa');
                            $('#cnpjEmpresaDisplay').text('---');
                        } else {
                            const nomeEl = document.getElementById('nomeEmpresaDisplay');
                            const cnpjEl = document.getElementById('cnpjEmpresaDisplay');
                            if (nomeEl) nomeEl.textContent = 'Empresa';
                            if (cnpjEl) cnpjEl.textContent = '---';
                        }
                    } catch (fallbackError) {
                        console.error('❌ [QUESTIONARIO] Erro no fallback:', fallbackError);
                    }
                }
                
                // Começar direto na primeira pergunta
                try {
                    console.log('Iniciando primeira pergunta...');
                    perguntaAtual = 1;
                    
                    console.log('Chamando mostrarPergunta(1)...');
                    mostrarPergunta(perguntaAtual);
                    
                    console.log('Chamando atualizarProgresso()...');
                    atualizarProgresso();
                    
                    console.log('Questionário inicializado com sucesso!');
                } catch (questionError) {
                    console.error('Erro ao inicializar questionário:', questionError);
                }
                
                console.log('Dados carregados da página inicial:', dadosEmpresa);
            } else {
                // CNPJ inválido ou dados insuficientes
                console.log('❌ [QUESTIONARIO] Dados insuficientes para prosseguir:');
                console.log('- temCNPJ:', temCNPJ);
                console.log('- cnpjValidado:', cnpjValidado);
                console.log('- dados_receita:', !!dadosCarregados.dados_receita);
                console.log('- Condição falhou em:', {
                    temCNPJ: temCNPJ,
                    condicaoValidacao: cnpjValidado || dadosCarregados.dados_receita,
                    cnpjValidado: cnpjValidado,
                    temDadosReceita: !!dadosCarregados.dados_receita
                });
                
                alert('CNPJ inválido ou não encontrado. Por favor, verifique o CNPJ e tente novamente.');
                window.location.href = '/';
                return;
            }
        } catch (error) {
            console.error('❌ [QUESTIONARIO] Erro ao carregar dados do sessionStorage:', error);
            console.log('❌ [QUESTIONARIO] Dados que causaram erro:', dadosEmpresaStorage);
            
            alert('Erro ao processar dados da empresa. Por favor, refaça o processo.');
            window.location.href = '/';
            return;
        }
    } else {
        console.log('❌ [QUESTIONARIO] SessionStorage vazio');
        alert('Por favor, preencha os dados da empresa primeiro.');
        window.location.href = '/';
        return;
    }
    
    // Adicionar listeners para todas as opções de pergunta
    function setupEventListeners() {
        if (window.jQuery && window.$) {
            // Usar jQuery se disponível
            $(document).on('change', 'input[type="radio"]', function() {
                verificarResposta();
                
                // Melhorar visual das opções selecionadas
                const perguntaContainer = $(this).closest('.pergunta-container');
                perguntaContainer.find('.opcao-item label').removeClass('btn-primary').addClass('btn-outline-primary');
                perguntaContainer.find('.fas.fa-circle-check').addClass('d-none');
                perguntaContainer.find('.fas.fa-circle').removeClass('d-none');
                
                // Destacar opção selecionada
                const labelSelecionado = $(this).next('label');
                labelSelecionado.removeClass('btn-outline-primary').addClass('btn-primary');
                labelSelecionado.find('.fas.fa-circle').addClass('d-none');
                labelSelecionado.find('.fas.fa-circle-check').removeClass('d-none');
            });
        } else {
            // Usar JavaScript vanilla
            document.addEventListener('change', function(e) {
                if (e.target.type === 'radio') {
                    verificarResposta();
                    
                    // Melhorar visual das opções selecionadas
                    const perguntaContainer = e.target.closest('.pergunta-container');
                    if (perguntaContainer) {
                        const labels = perguntaContainer.querySelectorAll('.opcao-item label');
                        labels.forEach(label => {
                            label.classList.remove('btn-primary');
                            label.classList.add('btn-outline-primary');
                            
                            const checkIcon = label.querySelector('.fas.fa-circle-check');
                            const circleIcon = label.querySelector('.fas.fa-circle');
                            if (checkIcon) checkIcon.classList.add('d-none');
                            if (circleIcon) circleIcon.classList.remove('d-none');
                        });
                        
                        // Destacar opção selecionada
                        const labelSelecionado = e.target.nextElementSibling;
                        if (labelSelecionado) {
                            labelSelecionado.classList.remove('btn-outline-primary');
                            labelSelecionado.classList.add('btn-primary');
                            
                            const checkIcon = labelSelecionado.querySelector('.fas.fa-circle-check');
                            const circleIcon = labelSelecionado.querySelector('.fas.fa-circle');
                            if (checkIcon) checkIcon.classList.remove('d-none');
                            if (circleIcon) circleIcon.classList.add('d-none');
                        }
                    }
                }
            });
        }
    }
    
    // Configurar event listeners
    setupEventListeners();
});
</script>
{% endblock %}
