{% extends "base.html" %}

{% block title %}Questionário - Programa Equilíbrio{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="progress shadow-sm" style="height: 12px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: 0%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));" id="progressBar"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted fw-bold">Questão <span id="etapaAtual">1</span> de {{ perguntas|length }}</small>
                    <small class="text-muted fw-bold"><span id="porcentagem">0</span>% concluído</small>
                </div>
            </div>

            <!-- Dados da empresa (exibição compacta) -->
            <div class="mb-4">
                <div class="alert alert-primary d-flex align-items-center">
                    <i class="fas fa-building me-2"></i>
                    <div>
                        <strong id="nomeEmpresaDisplay">Carregando dados...</strong><br>
                        <small>CNPJ: <span id="cnpjEmpresaDisplay"></span></small>
                    </div>
                </div>
            </div>

            <!-- Questionário -->
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <form id="formQuestionario">
                        <!-- Perguntas do questionário -->
                        {% for pergunta in perguntas %}
                        <div class="pergunta-container" data-pergunta="{{ pergunta.id }}" 
                             {% if pergunta.id != 1 %}style="display: none;"{% endif %}>
                            
                            <div class="mb-4">
                                <h4 class="fw-bold mb-3" style="color: var(--primary-color);">{{ pergunta.titulo }}</h4>
                                <p class="text-muted fst-italic">
                                    <i class="fas fa-target me-2" style="color: var(--secondary-color);"></i>
                                    {{ pergunta.objetivo }}
                                </p>
                            </div>

                            <div class="opcoes-container">
                                {% for opcao in pergunta.opcoes %}
                                <div class="opcao-item mb-3">
                                    <input type="radio" class="btn-check" 
                                           name="pergunta_{{ pergunta.id }}" 
                                           value="{{ opcao.valor }}" 
                                           id="opcao_{{ pergunta.id }}_{{ loop.index }}"
                                           autocomplete="off">
                                    <label class="btn btn-outline-primary btn-lg w-100 text-start p-4" 
                                           for="opcao_{{ pergunta.id }}_{{ loop.index }}"
                                           style="transition: all 0.3s ease; border: 2px solid #dee2e6;">
                                        <div class="d-flex align-items-start">
                                            <div class="me-3 pt-1">
                                                <i class="fas fa-circle-check text-success d-none"></i>
                                                <i class="fas fa-circle text-muted"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold mb-2" style="font-size: 1.1rem;">{{ opcao.texto }}</div>
                                                {% if opcao.descricao %}
                                                <div class="text-muted">{{ opcao.descricao }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="navegacao-container d-flex justify-content-between align-items-center mt-5">
                                <button type="button" class="btn btn-outline-secondary" onclick="perguntaAnterior()" 
                                        {% if pergunta.id == 1 %}style="visibility: hidden;"{% endif %}>
                                    <i class="fas fa-arrow-left me-2"></i> Anterior
                                </button>
                                
                                <div class="text-center">
                                    <small class="text-muted">Pergunta {{ pergunta.id }} de {{ perguntas|length }}</small>
                                </div>

                                {% if pergunta.id < perguntas|length %}
                                <button type="button" class="btn btn-primary btn-lg" onclick="proximaPergunta()" disabled>
                                    Próxima <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-success btn-lg" onclick="proximaPergunta()" disabled>
                                    Finalizar Diagnóstico <i class="fas fa-check ms-2"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary mb-4" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <h5 class="mb-2" id="loadingText">Processando diagnóstico...</h5>
                <p class="text-muted mb-0" id="loadingSubText">
                    Analisando as respostas e gerando recomendações personalizadas.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
// Variáveis globais
let dadosEmpresa = {};
let respostas = {};
let perguntaAtual = 1;
const totalPerguntas = parseInt('{{ perguntas|length }}');

// Função para atualizar a barra de progresso
function atualizarProgresso() {
    try {
        const totalPerguntasLocal = parseInt('{{ perguntas|length }}') || 1; // Evitar divisão por zero
        const porcentagem = Math.round(((perguntaAtual - 1) / totalPerguntasLocal) * 100);
        
        console.log(`Progresso: pergunta ${perguntaAtual} de ${totalPerguntasLocal} (${porcentagem}%)`);
        
        $('#progressBar').css('width', porcentagem + '%');
        $('#etapaAtual').text(perguntaAtual);
        $('#porcentagem').text(porcentagem);
    } catch (error) {
        console.error('Erro em atualizarProgresso:', error);
    }
}

// Função para mostrar pergunta específica
function mostrarPergunta(numero) {
    try {
        console.log(`Mostrando pergunta ${numero}...`);
        $('.pergunta-container').hide();
        
        const perguntaElement = $('.pergunta-container[data-pergunta="' + numero + '"]');
        console.log(`Elemento da pergunta encontrado: ${perguntaElement.length > 0}`);
        
        if (perguntaElement.length > 0) {
            perguntaElement.show();
            console.log(`Pergunta ${numero} exibida com sucesso`);
        } else {
            console.error(`Pergunta ${numero} não encontrada!`);
        }
    } catch (error) {
        console.error('Erro em mostrarPergunta:', error);
    }
}

// Função para próxima pergunta
function proximaPergunta() {
    if (perguntaAtual < totalPerguntas) {
        perguntaAtual++;
        mostrarPergunta(perguntaAtual);
        atualizarProgresso();
        // Scroll para o topo
        $('html, body').animate({ scrollTop: 0 }, 500);
    } else {
        finalizarQuestionario();
    }
}

// Função para pergunta anterior
function perguntaAnterior() {
    if (perguntaAtual > 1) {
        perguntaAtual--;
        mostrarPergunta(perguntaAtual);
        atualizarProgresso();
        // Scroll para o topo
        $('html, body').animate({ scrollTop: 0 }, 500);
    }
}

// Função para verificar se pergunta foi respondida
function verificarResposta() {
    const opcaoSelecionada = $('input[name="pergunta_' + perguntaAtual + '"]:checked');
    const botaoProximo = $('.pergunta-container[data-pergunta="' + perguntaAtual + '"] .btn-primary, .pergunta-container[data-pergunta="' + perguntaAtual + '"] .btn-success');
    
    if (opcaoSelecionada.length > 0) {
        respostas[perguntaAtual] = opcaoSelecionada.val();
        botaoProximo.prop('disabled', false);
    } else {
        botaoProximo.prop('disabled', true);
    }
}

// Função para formatar CNPJ
function formatarCNPJ(cnpj) {
    const digits = cnpj.replace(/\D/g, '');
    return digits.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
}

function finalizarQuestionario() {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    $('#loadingText').text('Processando diagnóstico...');
    $('#loadingSubText').text('Analisando as respostas e gerando recomendações personalizadas.');
    loadingModal.show();
    
    const dadosCompletos = {
        dados_empresa: dadosEmpresa,
        respostas: respostas
    };
    
    $.ajax({
        url: '/processar_questionario',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(dadosCompletos),
        success: function(response) {
            loadingModal.hide();
            
            if (response.status === 'success') {
                window.location.href = response.redirect;
            } else {
                alert('Erro: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            loadingModal.hide();
            
            let errorMessage = 'Erro ao processar questionário.';
            try {
                const errorData = JSON.parse(xhr.responseText);
                errorMessage = errorData.message || errorMessage;
            } catch (e) {
                // Usar mensagem padrão
            }
            
            alert(errorMessage + ' Por favor, tente novamente.');
        }
    });
}

// Event listeners para as opções
document.addEventListener('DOMContentLoaded', function() {
    // Carregar dados da empresa do sessionStorage
    const dadosEmpresaStorage = sessionStorage.getItem('dadosEmpresa');
    
    if (dadosEmpresaStorage) {
        try {
            const dadosCarregados = JSON.parse(dadosEmpresaStorage);
            
            // DEBUG: Mostrar dados carregados
            console.log('Dados do sessionStorage:', dadosCarregados);
            console.log('cnpj_validado:', dadosCarregados.cnpj_validado);
            console.log('dados_receita:', dadosCarregados.dados_receita);
            console.log('cnpj:', dadosCarregados.cnpj);
            
            // Verificar se CNPJ existe nos dados (mais flexível)
            const temCNPJ = dadosCarregados.cnpj || (dadosCarregados.dados_receita && dadosCarregados.dados_receita.cnpj);
            const cnpjValidado = dadosCarregados.cnpj_validado === true;
            
            console.log('temCNPJ:', temCNPJ);
            console.log('cnpjValidado:', cnpjValidado);
            
            // Permitir prosseguir se tem CNPJ válido, mesmo sem todos os dados da Receita
            if (temCNPJ && (cnpjValidado || dadosCarregados.dados_receita)) {
                // Usar dados da página inicial
                dadosEmpresa = dadosCarregados;
                
                console.log('Dados validados - prosseguindo com o questionário');
                
                // Exibir dados da empresa na barra superior
                let razaoSocial = 'Empresa';
                let cnpj = '---';
                
                try {
                    // Tentar pegar dados da receita primeiro, depois dados básicos
                    if (dadosCarregados.dados_receita) {
                        razaoSocial = dadosCarregados.dados_receita.razao_social || 
                                    dadosCarregados.dados_receita.nome || 
                                    dadosCarregados.razao_social || 
                                    dadosCarregados.nome_empresa || 
                                    'Empresa';
                        cnpj = formatarCNPJ(dadosCarregados.dados_receita.cnpj || dadosCarregados.cnpj);
                    } else {
                        razaoSocial = dadosCarregados.razao_social || 
                                    dadosCarregados.nome_empresa || 
                                    'Empresa';
                        cnpj = formatarCNPJ(dadosCarregados.cnpj);
                    }
                    
                    $('#nomeEmpresaDisplay').text(razaoSocial);
                    $('#cnpjEmpresaDisplay').text(cnpj);
                    
                    console.log('Dados exibidos - Razão:', razaoSocial, 'CNPJ:', cnpj);
                } catch (displayError) {
                    console.error('Erro ao exibir dados da empresa:', displayError);
                    $('#nomeEmpresaDisplay').text('Empresa');
                    $('#cnpjEmpresaDisplay').text(cnpj || '---');
                }
                
                // Começar direto na primeira pergunta
                try {
                    console.log('Iniciando primeira pergunta...');
                    perguntaAtual = 1;
                    
                    console.log('Chamando mostrarPergunta(1)...');
                    mostrarPergunta(perguntaAtual);
                    
                    console.log('Chamando atualizarProgresso()...');
                    atualizarProgresso();
                    
                    console.log('Questionário inicializado com sucesso!');
                } catch (questionError) {
                    console.error('Erro ao inicializar questionário:', questionError);
                }
                
                console.log('Dados carregados da página inicial:', dadosEmpresa);
            } else {
                // CNPJ inválido ou dados insuficientes
                console.log('Dados insuficientes para prosseguir:');
                console.log('- temCNPJ:', temCNPJ);
                console.log('- cnpjValidado:', cnpjValidado);
                console.log('- dados_receita:', !!dadosCarregados.dados_receita);
                
                alert('CNPJ inválido ou não encontrado. Por favor, verifique o CNPJ e tente novamente.');
                window.location.href = '/';
                return;
            }
        } catch (error) {
            console.error('Erro ao carregar dados do sessionStorage:', error);
            console.log('Dados do sessionStorage que causaram erro:', dadosEmpresaStorage);
            
            alert('Erro ao processar dados da empresa. Por favor, refaça o processo.');
            window.location.href = '/';
            return;
        }
    } else {
        alert('Por favor, preencha os dados da empresa primeiro.');
        window.location.href = '/';
        return;
    }
    
    // Adicionar listeners para todas as opções de pergunta
    $(document).on('change', 'input[type="radio"]', function() {
        verificarResposta();
        
        // Melhorar visual das opções selecionadas
        const perguntaContainer = $(this).closest('.pergunta-container');
        perguntaContainer.find('.opcao-item label').removeClass('btn-primary').addClass('btn-outline-primary');
        perguntaContainer.find('.fas.fa-circle-check').addClass('d-none');
        perguntaContainer.find('.fas.fa-circle').removeClass('d-none');
        
        // Destacar opção selecionada
        const labelSelecionado = $(this).next('label');
        labelSelecionado.removeClass('btn-outline-primary').addClass('btn-primary');
        labelSelecionado.find('.fas.fa-circle').addClass('d-none');
        labelSelecionado.find('.fas.fa-circle-check').removeClass('d-none');
    });
});
</script>
{% endblock %}
